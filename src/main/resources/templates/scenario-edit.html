<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
    <link rel="stylesheet" th:href="@{/css/dark-theme.css}">
    <script th:src="@{/js/theme.js}"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            margin: 0;
            padding: 40px 20px;
            padding-top: 120px;
            background-color: #f5f5f5;
        }
        .fixed-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 16px 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .fixed-nav .nav-links {
            display: flex;
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .nav-links-main {
            display: flex;
            gap: 16px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }
        .nav-links-right {
            position: absolute;
            right: 0;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .nav-link.secondary {
            padding: 8px 16px;
            font-size: 13px;
            min-width: auto;
        }
        .nav-link.faq {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(244, 67, 54, 0.2);
        }
        .nav-link.faq:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        .nav-link {
            padding: 14px 28px;
            text-decoration: none;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            /* –ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –µ—Å–ª–∏ –∫–ª–∞—Å—Å –Ω–µ —É–∫–∞–∑–∞–Ω */
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
        }
        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .nav-link.mocks {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(29, 114, 184, 0.2);
        }
        .nav-link.mocks:hover {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .nav-link.active {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .nav-link.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(29, 114, 184, 0.4);
        }
        /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–ª–∏ —Å–∏–Ω–∏–π —Ü–≤–µ—Ç */
        .nav-link.status.active {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%) !important;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4) !important;
        }
        .nav-link.groups.active {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%) !important;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4) !important;
        }
        .nav-link.faq.active {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%) !important;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4) !important;
        }
        .nav-link.mocks.active {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.4);
        }
        .nav-link.template {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(156, 39, 176, 0.2);
        }
        .nav-link.template:hover {
            background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }
        .nav-link.scenario {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.2);
        }
        .nav-link.scenario:hover {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }
        .nav-link.scenario.active {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }
        .nav-link.groups {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
        }
        .nav-link.groups:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        .nav-link.groups.active {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 32px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .back-link {
            display: inline-block;
            margin-bottom: 24px;
            text-decoration: none;
            color: #666;
            font-size: 14px;
            padding: 6px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .back-link:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }
        h1 { 
            margin: 0 0 8px 0; 
            font-size: 28px; 
            font-weight: 600;
            color: #333; 
        }
        .form-group {
            margin-bottom: 24px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .system-select {
            margin-bottom: 32px;
        }
        .templates-section {
            margin-bottom: 32px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        .templates-section h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
            color: #ff9800;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
        }
        .mock-group {
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
        }
        .mock-group h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .template-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fafafa;
            transition: all 0.2s;
        }
        .template-checkbox:hover {
            background: #f0f0f0;
            border-color: #ff9800;
        }
        .template-checkbox input[type="checkbox"] {
            width: auto;
            margin-right: 12px;
            cursor: pointer;
        }
        .template-checkbox label {
            flex: 1;
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }
        .template-info {
            font-size: 12px;
            color: #666;
            margin-left: 28px;
        }
        .time-points {
            margin-top: 32px;
        }
        .time-point {
            margin-bottom: 24px;
            padding: 20px;
            border: 2px solid #ff9800;
            border-radius: 6px;
            background: #fff8e1;
        }
        .time-point-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .time-point-title {
            font-size: 18px;
            font-weight: 600;
            color: #ff9800;
        }
        .time-input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }
        .time-input-group input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }
        .time-input-group input:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        .remove-time-btn {
            padding: 6px 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .remove-time-btn:hover {
            background: #d32f2f;
        }
        .add-time-btn {
            padding: 12px 24px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-top: 16px;
        }
        .add-time-btn:hover {
            background: #f57c00;
        }
        .actions {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-save {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(29, 114, 184, 0.2);
        }
        .btn-save:hover {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .btn-scenario {
            background: #ff9800;
            color: white;
        }
        .btn-scenario:hover {
            background: #f57c00;
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #ffcdd2;
        }
    </style>
</head>
<body>
<div class="fixed-nav">
    <div class="nav-links">
        <div class="nav-links-main">
            <a href="/" class="nav-link mocks">–ó–∞–≥–ª—É—à–∫–∏</a>
            <a href="/templates" class="nav-link template">–®–∞–±–ª–æ–Ω—ã</a>
            <a href="/scenarios" class="nav-link scenario active">–°—Ü–µ–Ω–∞—Ä–∏–∏</a>
        </div>
        <div class="nav-links-right">
            <a href="/groups" class="nav-link groups secondary">–ì—Ä—É–ø–ø—ã</a>
            <a href="/status" class="nav-link status secondary">–°—Ç–∞—Ç—É—Å—ã</a>
            <a th:if="${faqUrl != null && !faqUrl.isEmpty()}" th:href="${faqUrl}" target="_blank" class="nav-link faq secondary">FAQ</a>
            <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
        </div>
    </div>
</div>

<div class="container">
    <a th:href="@{/scenarios/{id}(id=${scenario.id})}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å—Ü–µ–Ω–∞—Ä–∏—é</a>
    <h1>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</h1>

    <div th:if="${param.error}" class="error" th:text="${param.error[0]}"></div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <form id="scenarioForm">
        <input type="hidden" id="scenarioId" th:value="${scenario.id}"/>
        <div class="form-group">
            <label for="scenarioName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è *</label>
            <input type="text" id="scenarioName" name="name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–∫–∞–∑—ã –∑–∞–≥–ª—É—à–µ–∫" maxlength="255" th:value="${scenario.name}"/>
        </div>

        <div class="form-group system-select">
            <label for="groupSelect">–ì—Ä—É–ø–ø–∞ *</label>
            <select id="groupSelect" name="group" required>
                <option th:each="group : ${groups}" 
                        th:value="${group.id}" 
                        th:text="${group.name}"
                        th:selected="${scenario.groupId == group.id}">group</option>
            </select>
        </div>

        <!-- –®–∞–±–ª–æ–Ω—ã –¥–ª—è –≥—Ä—É–ø–ø—ã -->
        <div id="templatesSection" th:if="${mocksWithTemplates != null && !mocksWithTemplates.isEmpty()}" class="templates-section">
            <h3>–®–∞–±–ª–æ–Ω—ã –¥–ª—è –≥—Ä—É–ø–ø—ã</h3>
            
            <div th:each="mockWithTemplates : ${mocksWithTemplates}" class="mock-group">
                <h4 th:text="${mockWithTemplates.mockName}">mock-name</h4>
                <div th:each="template : ${mockWithTemplates.templates}" class="template-checkbox">
                    <input type="checkbox" 
                           th:id="'template_' + ${template.id}"
                           th:value="${template.id}"
                           class="template-checkbox-input"
                           th:checked="${usedTemplateIds != null && usedTemplateIds.contains(template.id)}"/>
                    <label th:for="'template_' + ${template.id}" th:text="${mockWithTemplates.mockName + ' - ' + template.name}">Mock Name - Template Name</label>
                    <div class="template-info" th:if="${template.description}" th:text="${template.description}"></div>
                </div>
            </div>
        </div>

        <div th:if="${selectedSystem == null}" class="empty-state">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã</p>
        </div>

        <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ -->
        <div class="time-points">
            <h2 style="margin-bottom: 16px; color: #ff9800;">–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏</h2>
            <div id="timePointsContainer">
                <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <button type="button" class="add-time-btn" onclick="addTimePoint()">+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è</button>
        </div>

        <div class="actions">
            <button type="submit" class="btn btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
    </form>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const scenarioData = {
        id: /*[[${scenario.id}]]*/ '',
        name: /*[[${scenario.name}]]*/ '',
        description: /*[[${scenario.description != null ? scenario.description : ''}]]*/ '',
        steps: [
            /*[# th:each="step, iterStat : ${scenario.steps}"]*/
            {
                id: /*[[${step.id}]]*/ '',
                templateId: /*[[${step.templateId != null ? step.templateId : ''}]]*/ '',
                scheduledTime: /*[[${step.scheduledTime != null ? step.scheduledTime.toString() : 'null'}]]*/ 'null',
                comment: /*[[${step.comment != null ? step.comment : 'null'}]]*/ 'null'
            }/*[# th:if="${!iterStat.last}"]*/,/*[/]*/
            /*[/]*/
        ],
        usedTemplateIds: [
            /*[# th:if="${usedTemplateIds != null && !usedTemplateIds.isEmpty()}"]*/
            /*[# th:each="templateId, iterStat : ${usedTemplateIds}"]*/
            /*[[${templateId}]]*//*[# th:if="${!iterStat.last}"]*/,/*[/]*/
            /*[/]*/
            /*[/]*/
        ]
    };
    /*]]>*/
</script>

<script>
    let timePointCounter = 0;

    function loadTemplatesForSystem(system) {
        const scenarioId = document.getElementById('scenarioId').value;
        if (system) {
            window.location.href = '/scenarios/' + scenarioId + '/edit?system=' + encodeURIComponent(system);
        } else {
            window.location.href = '/scenarios/' + scenarioId + '/edit';
        }
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º scheduledTime (Instant) –≤ –¥–µ–Ω—å –∏ –≤—Ä–µ–º—è
    function parseScheduledTime(scheduledTimeStr) {
        if (!scheduledTimeStr) return { day: 0, time: '00:00' };
        
        // –§–æ—Ä–º–∞—Ç: "HH:mm:ss dd-MM-yyyy"
        const parts = scheduledTimeStr.split(' ');
        if (parts.length !== 2) return { day: 0, time: '00:00' };
        
        const timePart = parts[0]; // HH:mm:ss
        const datePart = parts[1]; // dd-MM-yyyy
        
        const [hours, minutes] = timePart.split(':');
        const time = hours + ':' + minutes;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –¥–µ–Ω—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ–≥–æ–¥–Ω—è
        const [day, month, year] = datePart.split('-').map(Number);
        const today = new Date();
        const targetDate = new Date(year, month - 1, day);
        const diffTime = targetDate - today;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        return { day: Math.max(0, diffDays), time: time };
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫
    function initializeTimePoints() {
        if (!scenarioData || !scenarioData.steps || scenarioData.steps.length === 0) {
            return;
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —à–∞–≥–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        const stepsByTime = {};
        scenarioData.steps.forEach((step) => {
            if (!step.templateId) {
                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —à–∞–≥–∏ –±–µ–∑ templateId
            }
            
            let timeKey = '00:00';
            let day = 0;
            
            if (step.scheduledTime && step.scheduledTime !== 'null' && step.scheduledTime !== null) {
                try {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Instant (ISO —Å—Ç—Ä–æ–∫–∞) –≤ Date
                    // Instant –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO 8601, –Ω–∞–ø—Ä–∏–º–µ—Ä: "2025-11-27T12:00:00Z"
                    const instant = new Date(step.scheduledTime);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞
                    if (isNaN(instant.getTime())) {
                        return;
                    }
                    
                    // –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
                    const year = instant.getFullYear();
                    const month = String(instant.getMonth() + 1).padStart(2, '0');
                    const dayNum = String(instant.getDate()).padStart(2, '0');
                    const hours = String(instant.getHours()).padStart(2, '0');
                    const minutes = String(instant.getMinutes()).padStart(2, '0');
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –¥–µ–Ω—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ–≥–æ–¥–Ω—è
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const targetDate = new Date(year, parseInt(month) - 1, parseInt(dayNum));
                    targetDate.setHours(0, 0, 0, 0);
                    const diffTime = targetDate - today;
                    day = Math.max(0, Math.floor(diffTime / (1000 * 60 * 60 * 24)));
                    timeKey = hours + ':' + minutes;
                } catch (e) {
                    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —à–∞–≥
                }
            }
            
            const key = day + '_' + timeKey;
            if (!stepsByTime[key]) {
                const commentValue = (step.comment && step.comment !== 'null' && step.comment !== null) ? step.comment : '';
                stepsByTime[key] = { day: day, time: timeKey, templateIds: [], comment: commentValue };
            }
            if (step.templateId) {
                stepsByTime[key].templateIds.push(step.templateId);
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ —Å —Ç–∞–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
            if (step.comment && step.comment !== 'null' && step.comment !== null && !stepsByTime[key].comment) {
                stepsByTime[key].comment = step.comment;
            }
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–Ω—é –∏ –≤—Ä–µ–º–µ–Ω–∏
        const sortedTimePoints = Object.values(stepsByTime).sort((a, b) => {
            if (a.day !== b.day) return a.day - b.day;
            const [aHours, aMinutes] = a.time.split(':').map(Number);
            const [bHours, bMinutes] = b.time.split(':').map(Number);
            if (aHours !== bHours) return aHours - bHours;
            return aMinutes - bMinutes;
        });
        
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
        if (sortedTimePoints.length === 0) {
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–∫—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫
        const templatesSection = document.getElementById('templatesSection');
        if (!templatesSection) {
            setTimeout(() => {
                sortedTimePoints.forEach((timePoint) => {
                    addTimePointWithData(timePoint.day, timePoint.time, timePoint.templateIds, timePoint.comment || '');
                });
            }, 300);
            return;
        }
        
        sortedTimePoints.forEach((timePoint) => {
            addTimePointWithData(timePoint.day, timePoint.time, timePoint.templateIds, timePoint.comment || '');
        });
    }

    function addTimePoint() {
        addTimePointWithData(0, '00:00', [], '');
    }

    function addTimePointWithData(day, time, templateIds, comment) {
        timePointCounter++;
        const container = document.getElementById('timePointsContainer');
        const timePointDiv = document.createElement('div');
        timePointDiv.className = 'time-point';
        timePointDiv.id = 'timePoint_' + timePointCounter;
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
        const availableTemplates = getAvailableTemplates(templateIds);
        
        timePointDiv.innerHTML = `
            <div class="time-point-header">
                <span class="time-point-title">–í—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ ${timePointCounter}</span>
                <button type="button" class="remove-time-btn" onclick="removeTimePoint(${timePointCounter})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div class="time-input-group">
                <label style="width: auto; margin: 0; font-weight: 500;">–î–µ–Ω—å:</label>
                <input type="number" 
                       name="timePoint_${timePointCounter}_day" 
                       id="timePoint_${timePointCounter}_day"
                       placeholder="0"
                       min="0"
                       value="${day}"
                       style="width: 80px;"
                       required/>
                <label style="width: auto; margin: 0; font-weight: 500; margin-left: 12px;">–í—Ä–µ–º—è (HH:mm):</label>
                <input type="text" 
                       name="timePoint_${timePointCounter}_time" 
                       id="timePoint_${timePointCounter}_time"
                       placeholder="00:00"
                       pattern="[0-9]{2}:[0-9]{2}"
                       maxlength="5"
                       value="${time}"
                       required/>
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:</label>
                <div id="timePoint_${timePointCounter}_templates">
                    ${availableTemplates}
                </div>
            </div>
            <div style="margin-top: 12px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                <input type="text" 
                       name="timePoint_${timePointCounter}_comment" 
                       id="timePoint_${timePointCounter}_comment"
                       placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —ç—Ç–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏"
                       maxlength="500"
                       value="${comment || ''}"
                       style="width: 100%; padding: 8px; border: 1px solid #d0d0d0; border-radius: 4px;"/>
            </div>
        `;
        
        container.appendChild(timePointDiv);
        
        // –û—Ç–º–µ—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
        if (templateIds && templateIds.length > 0) {
            templateIds.forEach(templateId => {
                const checkbox = document.getElementById('timePoint_' + timePointCounter + '_template_' + templateId);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Å–∫—É –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏
        const timeInput = document.getElementById('timePoint_' + timePointCounter + '_time');
        timeInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) value = value.substring(0, 4);
            if (value.length >= 2) {
                value = value.substring(0, 2) + ':' + value.substring(2);
            }
            e.target.value = value;
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤
    function updateAllTimePoints() {
        const timePointElements = document.querySelectorAll('.time-point');
        timePointElements.forEach(timePoint => {
            const templatesContainer = timePoint.querySelector('[id^="timePoint_"][id$="_templates"]');
            if (templatesContainer) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –≤ —ç—Ç–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–µ
                const selectedCheckboxes = templatesContainer.querySelectorAll('input[type="checkbox"]:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤
                templatesContainer.innerHTML = getAvailableTemplates(selectedIds);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
                selectedIds.forEach(templateId => {
                    const checkbox = templatesContainer.querySelector(`input[value="${templateId}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
        });
    }

    function removeTimePoint(id) {
        const timePoint = document.getElementById('timePoint_' + id);
        if (timePoint) {
            timePoint.remove();
        }
    }

    function getAvailableTemplates(selectedTemplateIds) {
        const templatesSection = document.getElementById('templatesSection');
        if (!templatesSection) {
            // –ï—Å–ª–∏ —Å–µ–∫—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            // –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —à–∞–±–ª–æ–Ω—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –ø–æ–∑–∂–µ
            return '<p style="color: #999; font-style: italic;">–®–∞–±–ª–æ–Ω—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Å–∏—Å—Ç–µ–º—ã</p>';
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ–∫—Ü–∏–∏
        const checkedCheckboxes = templatesSection.querySelectorAll('.template-checkbox-input:checked');
        
        if (checkedCheckboxes.length === 0) {
            return '<p style="color: #999; font-style: italic;">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω—ã –≤—ã—à–µ</p>';
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ mock –≥—Ä—É–ø–ø–∞–º
        const mockGroups = {};
        checkedCheckboxes.forEach(checkbox => {
            const mockGroup = checkbox.closest('.mock-group');
            if (mockGroup) {
                const mockName = (mockGroup.querySelector('h4') || mockGroup.querySelector('h3'))?.textContent.trim() || '–î—Ä—É–≥–∏–µ';
                if (!mockGroups[mockName]) {
                    mockGroups[mockName] = [];
                }
                const label = checkbox.nextElementSibling;
                const labelText = label ? label.textContent.trim() : '';
                mockGroups[mockName].push({
                    id: checkbox.value,
                    name: labelText
                });
            }
        });
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
        if (Object.keys(mockGroups).length > 0) {
            let groupedHtml = '';
            for (const [mockName, templates] of Object.entries(mockGroups)) {
                groupedHtml += `<div class="mock-group" style="margin-bottom: 12px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #1d72b8;">${escapeHtml(mockName)}</h3><div class="template-checkbox-group">`;
                templates.forEach(template => {
                    const isChecked = selectedTemplateIds && selectedTemplateIds.includes(template.id) ? 'checked' : '';
                    groupedHtml += `
                        <div class="template-checkbox">
                            <input type="checkbox" 
                                   name="timePoint_${timePointCounter}_templates" 
                                   value="${escapeHtml(template.id)}"
                                   id="timePoint_${timePointCounter}_template_${escapeHtml(template.id)}"
                                   ${isChecked}/>
                            <label for="timePoint_${timePointCounter}_template_${escapeHtml(template.id)}" style="margin: 0;">${escapeHtml(template.name)}</label>
                        </div>
                    `;
                });
                groupedHtml += '</div></div>';
            }
            return groupedHtml;
        }
        
        return '<p style="color: #999; font-style: italic;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</p>';
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('scenarioForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const scenarioId = document.getElementById('scenarioId').value;
        const scenarioName = document.getElementById('scenarioName').value.trim();
        if (!scenarioName) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è');
            return;
        }
        
        const groupSelect = document.getElementById('groupSelect');
        if (!groupSelect || !groupSelect.value) {
            alert('–ì—Ä—É–ø–ø–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞');
            return;
        }
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
        const timePoints = [];
        const timePointElements = document.querySelectorAll('.time-point');
        
        if (timePointElements.length === 0) {
            alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–æ—á–∫—É');
            return;
        }
        
        let hasErrors = false;
        timePointElements.forEach((timePoint, index) => {
            const dayInput = timePoint.querySelector('input[type="number"]');
            const timeInput = timePoint.querySelector('input[type="text"]');
            const dayValue = parseInt(dayInput.value, 10) || 0;
            const timeValue = timeInput.value.trim();
            
            if (isNaN(dayValue) || dayValue < 0) {
                alert(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${index + 1}. –î–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >= 0`);
                hasErrors = true;
                return;
            }
            
            if (!timeValue) {
                alert(`–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${index + 1}`);
                hasErrors = true;
                return;
            }
            
            // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è HH:mm
            const timeParts = timeValue.split(':');
            if (timeParts.length !== 2) {
                alert(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${index + 1}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç HH:mm (00:00 - 23:59)`);
                hasErrors = true;
                return;
            }
            
            const hours = parseInt(timeParts[0], 10);
            const minutes = parseInt(timeParts[1], 10);
            
            if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                alert(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${index + 1}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç HH:mm (00:00 - 23:59)`);
                hasErrors = true;
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
            const templateCheckboxes = timePoint.querySelectorAll('input[type="checkbox"]:checked');
            if (templateCheckboxes.length === 0) {
                alert(`–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${index + 1}`);
                hasErrors = true;
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —ç—Ç–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏
            const commentInput = timePoint.querySelector('input[id$="_comment"]');
            const comment = commentInput ? commentInput.value.trim() : '';
            
            templateCheckboxes.forEach(checkbox => {
                timePoints.push({
                    day: dayValue,
                    time: timeValue,
                    templateId: checkbox.value,
                    comment: comment
                });
            });
        });
        
        if (hasErrors) {
            return;
        }
        
        if (timePoints.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è');
            return;
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–Ω—é –∏ –≤—Ä–µ–º–µ–Ω–∏
        timePoints.sort((a, b) => {
            if (a.day !== b.day) return a.day - b.day;
            const [aHours, aMinutes] = a.time.split(':').map(Number);
            const [bHours, bMinutes] = b.time.split(':').map(Number);
            if (aHours !== bHours) return aHours - bHours;
            return aMinutes - bMinutes;
        });
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å
        const today = new Date();
        const baseYear = today.getFullYear();
        const baseMonth = today.getMonth();
        const baseDay = today.getDate();
        
        const steps = timePoints.map((tp, index) => {
            const [hours, minutes] = tp.time.split(':').map(Number);
            const hoursStr = String(hours).padStart(2, '0');
            const minutesStr = String(minutes).padStart(2, '0');
            
            // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É —Å —É—á–µ—Ç–æ–º –¥–Ω—è
            const targetDate = new Date(baseYear, baseMonth, baseDay + tp.day);
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const day = String(targetDate.getDate()).padStart(2, '0');
            
            // –§–æ—Ä–º–∞—Ç: HH:mm:ss dd-MM-yyyy
            const scheduledTime = `${hoursStr}:${minutesStr}:00 ${day}-${month}-${year}`;
            return {
                templateId: tp.templateId,
                delayMs: 0,
                scheduledTime: scheduledTime,
                comment: tp.comment || null
            };
        });
        
        const requestBody = {
            name: scenarioName,
            description: null,
            groupId: groupSelect.value,
            steps: steps
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PUT –∑–∞–ø—Ä–æ—Å
        fetch('/api/scenarios/' + scenarioId, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.text().then(text => {
                    throw new Error(text || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è');
                });
            }
        })
        .then(data => {
            window.location.href = '/scenarios/' + data.id + '?info=' + encodeURIComponent('–°—Ü–µ–Ω–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è: ' + error.message);
        });
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã
        const groupSelect = document.getElementById('groupSelect');
        if (groupSelect) {
            groupSelect.addEventListener('change', function() {
                const scenarioId = document.getElementById('scenarioId').value;
                window.location.href = '/scenarios/' + scenarioId + '/edit';
            });
        }
        
        // –û—Ç–º–µ—á–∞–µ–º –≤—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —à–∞–±–ª–æ–Ω—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ–∫—Ü–∏–∏
        if (scenarioData && scenarioData.usedTemplateIds && scenarioData.usedTemplateIds.length > 0) {
            setTimeout(() => {
                scenarioData.usedTemplateIds.forEach(templateId => {
                    const checkbox = document.getElementById('template_' + templateId);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }, 50);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã —Å–µ–∫—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤ —É—Å–ø–µ–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
        setTimeout(() => {
            initializeTimePoints();
        }, 300);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ–∫—Ü–∏–∏
        setTimeout(() => {
            const templatesSection = document.getElementById('templatesSection');
            if (templatesSection) {
                const checkboxes = templatesSection.querySelectorAll('.template-checkbox-input');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞
                        updateAllTimePoints();
                    });
                });
            }
        }, 400);
    });
</script>
</body>
</html>

