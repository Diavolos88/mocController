<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Редактировать сценарий</title>
    <link rel="stylesheet" th:href="@{/css/dark-theme.css}">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            margin: 0;
            padding: 40px 20px;
            padding-top: 120px;
            background-color: #f5f5f5;
        }
        .fixed-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 16px 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .fixed-nav .nav-links {
            display: flex;
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .nav-links-main {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .nav-links-right {
            position: absolute;
            right: 0;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .nav-link.faq {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
        }
        .nav-link.faq:hover {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        .nav-link {
            padding: 14px 28px;
            text-decoration: none;
            border: none;
            border-radius: 8px;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .nav-link.mocks {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(29, 114, 184, 0.2);
        }
        .nav-link.mocks:hover {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .nav-link.active {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .nav-link.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(29, 114, 184, 0.4);
        }
        .nav-link.mocks.active {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.4);
        }
        .nav-link.template {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(156, 39, 176, 0.2);
        }
        .nav-link.template:hover {
            background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }
        .nav-link.scenario {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.2);
        }
        .nav-link.scenario:hover {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }
        .nav-link.scenario.active {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 32px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .back-link {
            display: inline-block;
            margin-bottom: 24px;
            text-decoration: none;
            color: #666;
            font-size: 14px;
            padding: 6px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .back-link:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }
        h1 { 
            margin: 0 0 8px 0; 
            font-size: 28px; 
            font-weight: 600;
            color: #333; 
        }
        .form-group {
            margin-bottom: 24px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .system-select {
            margin-bottom: 32px;
        }
        .templates-section {
            margin-bottom: 32px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        .templates-section h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
            color: #ff9800;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
        }
        .mock-group {
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
        }
        .mock-group h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .template-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fafafa;
            transition: all 0.2s;
        }
        .template-checkbox:hover {
            background: #f0f0f0;
            border-color: #ff9800;
        }
        .template-checkbox input[type="checkbox"] {
            width: auto;
            margin-right: 12px;
            cursor: pointer;
        }
        .template-checkbox label {
            flex: 1;
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }
        .template-info {
            font-size: 12px;
            color: #666;
            margin-left: 28px;
        }
        .time-points {
            margin-top: 32px;
        }
        .time-point {
            margin-bottom: 24px;
            padding: 20px;
            border: 2px solid #ff9800;
            border-radius: 6px;
            background: #fff8e1;
        }
        .time-point-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .time-point-title {
            font-size: 18px;
            font-weight: 600;
            color: #ff9800;
        }
        .time-input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }
        .time-input-group input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }
        .time-input-group input:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        .remove-time-btn {
            padding: 6px 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .remove-time-btn:hover {
            background: #d32f2f;
        }
        .add-time-btn {
            padding: 12px 24px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-top: 16px;
        }
        .add-time-btn:hover {
            background: #f57c00;
        }
        .actions {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-save {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(29, 114, 184, 0.2);
        }
        .btn-save:hover {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .btn-scenario {
            background: #ff9800;
            color: white;
        }
        .btn-scenario:hover {
            background: #f57c00;
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #ffcdd2;
        }
    </style>
</head>
<body>
<div class="fixed-nav">
    <div class="nav-links">
        <div class="nav-links-main">
            <a href="/" class="nav-link">Заглушки</a>
            <a href="/templates" class="nav-link template">Шаблоны</a>
            <a href="/scenarios" class="nav-link scenario active">Сценарии</a>
        </div>
        <div class="nav-links-right" th:if="${faqUrl != null && !faqUrl.isEmpty()}">
            <a th:href="${faqUrl}" target="_blank" class="nav-link faq">FAQ</a>
        </div>
    </div>
</div>

<div class="container">
    <a th:href="@{/scenarios/{id}(id=${scenario.id})}" class="back-link">← Назад к сценарию</a>
    <h1>Редактировать сценарий</h1>

    <div th:if="${param.error}" class="error" th:text="${param.error[0]}"></div>

    <!-- Индикатор загрузки -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Загрузка...</div>
        </div>
    </div>

    <form id="scenarioForm">
        <input type="hidden" id="scenarioId" th:value="${scenario.id}"/>
        <div class="form-group">
            <label for="scenarioName">Название сценария *</label>
            <input type="text" id="scenarioName" name="name" required placeholder="Например: Отказы заглушек" maxlength="255" th:value="${scenario.name}"/>
        </div>

        <div class="form-group">
            <label for="scenarioDescription">Описание (необязательно)</label>
            <textarea id="scenarioDescription" name="description" placeholder="Описание сценария..." th:text="${scenario.description != null ? scenario.description : ''}"></textarea>
        </div>

        <div class="form-group system-select">
            <label for="groupSelect">Группа *</label>
            <select id="groupSelect" name="group" required disabled>
                <option th:each="group : ${groups}" 
                        th:value="${group.id}" 
                        th:text="${group.name}"
                        th:selected="${scenario.groupId == group.id}">group</option>
            </select>
            <p style="margin-top: 8px; color: #666; font-size: 13px;">Группу нельзя изменить после создания сценария</p>
        </div>

        <!-- Шаблоны для группы -->
        <div id="templatesSection" th:if="${mocksWithTemplates != null && !mocksWithTemplates.isEmpty()}" class="templates-section">
            <h3>Шаблоны для группы</h3>
            
            <div th:each="mockWithTemplates : ${mocksWithTemplates}" class="mock-group">
                <h4 th:text="${mockWithTemplates.mockName}">mock-name</h4>
                <div th:each="template : ${mockWithTemplates.templates}" class="template-checkbox">
                    <input type="checkbox" 
                           th:id="'template_' + ${template.id}"
                           th:value="${template.id}"
                           class="template-checkbox-input"
                           th:checked="${usedTemplateIds != null && usedTemplateIds.contains(template.id)}"/>
                    <label th:for="'template_' + ${template.id}" th:text="${mockWithTemplates.mockName + ' - ' + template.name}">Mock Name - Template Name</label>
                    <div class="template-info" th:if="${template.description}" th:text="${template.description}"></div>
                </div>
            </div>
        </div>

        <div th:if="${selectedSystem == null}" class="empty-state">
            <p>Выберите систему, чтобы увидеть доступные шаблоны</p>
        </div>

        <!-- Временные точки -->
        <div class="time-points">
            <h2 style="margin-bottom: 16px; color: #ff9800;">Временные точки</h2>
            <div id="timePointsContainer">
                <!-- Временные точки будут добавляться динамически -->
            </div>
            <button type="button" class="add-time-btn" onclick="addTimePoint()">+ Добавить время</button>
        </div>

        <div class="actions">
            <button type="submit" class="btn btn-save">Сохранить изменения</button>
        </div>
    </form>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const scenarioData = {
        id: /*[[${scenario.id}]]*/ '',
        name: /*[[${scenario.name}]]*/ '',
        description: /*[[${scenario.description != null ? scenario.description : ''}]]*/ '',
        steps: [
            /*[# th:each="step, iterStat : ${scenario.steps}"]*/
            {
                id: /*[[${step.id}]]*/ '',
                templateId: /*[[${step.templateId != null ? step.templateId : ''}]]*/ '',
                scheduledTime: /*[[${step.scheduledTime != null ? step.scheduledTime.toString() : 'null'}]]*/ 'null'
            }/*[# th:if="${!iterStat.last}"]*/,/*[/]*/
            /*[/]*/
        ],
        usedTemplateIds: [
            /*[# th:if="${usedTemplateIds != null && !usedTemplateIds.isEmpty()}"]*/
            /*[# th:each="templateId, iterStat : ${usedTemplateIds}"]*/
            /*[[${templateId}]]*//*[# th:if="${!iterStat.last}"]*/,/*[/]*/
            /*[/]*/
            /*[/]*/
        ]
    };
    /*]]>*/
</script>

<script>
    let timePointCounter = 0;

    function loadTemplatesForSystem(system) {
        const scenarioId = document.getElementById('scenarioId').value;
        if (system) {
            window.location.href = '/scenarios/' + scenarioId + '/edit?system=' + encodeURIComponent(system);
        } else {
            window.location.href = '/scenarios/' + scenarioId + '/edit';
        }
    }

    // Преобразуем scheduledTime (Instant) в день и время
    function parseScheduledTime(scheduledTimeStr) {
        if (!scheduledTimeStr) return { day: 0, time: '00:00' };
        
        // Формат: "HH:mm:ss dd-MM-yyyy"
        const parts = scheduledTimeStr.split(' ');
        if (parts.length !== 2) return { day: 0, time: '00:00' };
        
        const timePart = parts[0]; // HH:mm:ss
        const datePart = parts[1]; // dd-MM-yyyy
        
        const [hours, minutes] = timePart.split(':');
        const time = hours + ':' + minutes;
        
        // Вычисляем день относительно сегодня
        const [day, month, year] = datePart.split('-').map(Number);
        const today = new Date();
        const targetDate = new Date(year, month - 1, day);
        const diffTime = targetDate - today;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        return { day: Math.max(0, diffDays), time: time };
    }

    // Инициализация существующих временных точек
    function initializeTimePoints() {
        if (!scenarioData || !scenarioData.steps || scenarioData.steps.length === 0) {
            return;
        }
        
        // Группируем шаги по времени
        const stepsByTime = {};
        scenarioData.steps.forEach((step) => {
            if (!step.templateId) {
                return; // Пропускаем шаги без templateId
            }
            
            let timeKey = '00:00';
            let day = 0;
            
            if (step.scheduledTime && step.scheduledTime !== 'null' && step.scheduledTime !== null) {
                try {
                    // Преобразуем Instant (ISO строка) в Date
                    // Instant приходит в формате ISO 8601, например: "2025-11-27T12:00:00Z"
                    const instant = new Date(step.scheduledTime);
                    
                    // Проверяем, что дата валидна
                    if (isNaN(instant.getTime())) {
                        return;
                    }
                    
                    // Получаем локальное время
                    const year = instant.getFullYear();
                    const month = String(instant.getMonth() + 1).padStart(2, '0');
                    const dayNum = String(instant.getDate()).padStart(2, '0');
                    const hours = String(instant.getHours()).padStart(2, '0');
                    const minutes = String(instant.getMinutes()).padStart(2, '0');
                    
                    // Вычисляем день относительно сегодня
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const targetDate = new Date(year, parseInt(month) - 1, parseInt(dayNum));
                    targetDate.setHours(0, 0, 0, 0);
                    const diffTime = targetDate - today;
                    day = Math.max(0, Math.floor(diffTime / (1000 * 60 * 60 * 24)));
                    timeKey = hours + ':' + minutes;
                } catch (e) {
                    return; // Пропускаем этот шаг
                }
            }
            
            const key = day + '_' + timeKey;
            if (!stepsByTime[key]) {
                stepsByTime[key] = { day: day, time: timeKey, templateIds: [] };
            }
            if (step.templateId) {
                stepsByTime[key].templateIds.push(step.templateId);
            }
        });
        
        // Сортируем по дню и времени
        const sortedTimePoints = Object.values(stepsByTime).sort((a, b) => {
            if (a.day !== b.day) return a.day - b.day;
            const [aHours, aMinutes] = a.time.split(':').map(Number);
            const [bHours, bMinutes] = b.time.split(':').map(Number);
            if (aHours !== bHours) return aHours - bHours;
            return aMinutes - bMinutes;
        });
        
        // Создаем временные точки
        if (sortedTimePoints.length === 0) {
            return;
        }
        
        // Проверяем, что секция шаблонов загружена перед созданием временных точек
        const templatesSection = document.getElementById('templatesSection');
        if (!templatesSection) {
            setTimeout(() => {
                sortedTimePoints.forEach((timePoint) => {
                    addTimePointWithData(timePoint.day, timePoint.time, timePoint.templateIds);
                });
            }, 300);
            return;
        }
        
        sortedTimePoints.forEach((timePoint) => {
            addTimePointWithData(timePoint.day, timePoint.time, timePoint.templateIds);
        });
    }

    function addTimePoint() {
        addTimePointWithData(0, '00:00', []);
    }

    function addTimePointWithData(day, time, templateIds) {
        timePointCounter++;
        const container = document.getElementById('timePointsContainer');
        const timePointDiv = document.createElement('div');
        timePointDiv.className = 'time-point';
        timePointDiv.id = 'timePoint_' + timePointCounter;
        
        // Получаем все доступные шаблоны
        const availableTemplates = getAvailableTemplates(templateIds);
        
        timePointDiv.innerHTML = `
            <div class="time-point-header">
                <span class="time-point-title">Временная точка ${timePointCounter}</span>
                <button type="button" class="remove-time-btn" onclick="removeTimePoint(${timePointCounter})">Удалить</button>
            </div>
            <div class="time-input-group">
                <label style="width: auto; margin: 0; font-weight: 500;">День:</label>
                <input type="number" 
                       name="timePoint_${timePointCounter}_day" 
                       id="timePoint_${timePointCounter}_day"
                       placeholder="0"
                       min="0"
                       value="${day}"
                       style="width: 80px;"
                       required/>
                <label style="width: auto; margin: 0; font-weight: 500; margin-left: 12px;">Время (HH:mm):</label>
                <input type="text" 
                       name="timePoint_${timePointCounter}_time" 
                       id="timePoint_${timePointCounter}_time"
                       placeholder="00:00"
                       pattern="[0-9]{2}:[0-9]{2}"
                       maxlength="5"
                       value="${time}"
                       required/>
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Выберите шаблоны для применения:</label>
                <div id="timePoint_${timePointCounter}_templates">
                    ${availableTemplates}
                </div>
            </div>
        `;
        
        container.appendChild(timePointDiv);
        
        // Отмечаем выбранные шаблоны
        if (templateIds && templateIds.length > 0) {
            templateIds.forEach(templateId => {
                const checkbox = document.getElementById('timePoint_' + timePointCounter + '_template_' + templateId);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        // Добавляем маску для времени
        const timeInput = document.getElementById('timePoint_' + timePointCounter + '_time');
        timeInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) value = value.substring(0, 4);
            if (value.length >= 2) {
                value = value.substring(0, 2) + ':' + value.substring(2);
            }
            e.target.value = value;
        });
    }
    
    // Функция для обновления всех временных точек при изменении выбора шаблонов
    function updateAllTimePoints() {
        const timePointElements = document.querySelectorAll('.time-point');
        timePointElements.forEach(timePoint => {
            const templatesContainer = timePoint.querySelector('[id^="timePoint_"][id$="_templates"]');
            if (templatesContainer) {
                // Сохраняем выбранные шаблоны в этой временной точке
                const selectedCheckboxes = templatesContainer.querySelectorAll('input[type="checkbox"]:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                
                // Обновляем список шаблонов
                templatesContainer.innerHTML = getAvailableTemplates(selectedIds);
                
                // Восстанавливаем выбранные шаблоны
                selectedIds.forEach(templateId => {
                    const checkbox = templatesContainer.querySelector(`input[value="${templateId}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
        });
    }

    function removeTimePoint(id) {
        const timePoint = document.getElementById('timePoint_' + id);
        if (timePoint) {
            timePoint.remove();
        }
    }

    function getAvailableTemplates(selectedTemplateIds) {
        const templatesSection = document.getElementById('templatesSection');
        if (!templatesSection) {
            // Если секция шаблонов еще не загружена, возвращаем сообщение
            // При инициализации это нормально, шаблоны загрузятся позже
            return '<p style="color: #999; font-style: italic;">Шаблоны будут доступны после выбора системы</p>';
        }
        
        // Получаем только выбранные шаблоны из основной секции
        const checkedCheckboxes = templatesSection.querySelectorAll('.template-checkbox-input:checked');
        
        if (checkedCheckboxes.length === 0) {
            return '<p style="color: #999; font-style: italic;">Сначала выберите шаблоны выше</p>';
        }
        
        // Группируем по mock группам
        const mockGroups = {};
        checkedCheckboxes.forEach(checkbox => {
            const mockGroup = checkbox.closest('.mock-group');
            if (mockGroup) {
                const mockName = (mockGroup.querySelector('h4') || mockGroup.querySelector('h3'))?.textContent.trim() || 'Другие';
                if (!mockGroups[mockName]) {
                    mockGroups[mockName] = [];
                }
                const label = checkbox.nextElementSibling;
                const labelText = label ? label.textContent.trim() : '';
                mockGroups[mockName].push({
                    id: checkbox.value,
                    name: labelText
                });
            }
        });
        
        // Формируем HTML с группировкой
        if (Object.keys(mockGroups).length > 0) {
            let groupedHtml = '';
            for (const [mockName, templates] of Object.entries(mockGroups)) {
                groupedHtml += `<div class="mock-group" style="margin-bottom: 12px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #1d72b8;">${escapeHtml(mockName)}</h3><div class="template-checkbox-group">`;
                templates.forEach(template => {
                    const isChecked = selectedTemplateIds && selectedTemplateIds.includes(template.id) ? 'checked' : '';
                    groupedHtml += `
                        <div class="template-checkbox">
                            <input type="checkbox" 
                                   name="timePoint_${timePointCounter}_templates" 
                                   value="${escapeHtml(template.id)}"
                                   id="timePoint_${timePointCounter}_template_${escapeHtml(template.id)}"
                                   ${isChecked}/>
                            <label for="timePoint_${timePointCounter}_template_${escapeHtml(template.id)}" style="margin: 0;">${escapeHtml(template.name)}</label>
                        </div>
                    `;
                });
                groupedHtml += '</div></div>';
            }
            return groupedHtml;
        }
        
        return '<p style="color: #999; font-style: italic;">Нет доступных шаблонов</p>';
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Обработка отправки формы
    document.getElementById('scenarioForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const scenarioId = document.getElementById('scenarioId').value;
        const scenarioName = document.getElementById('scenarioName').value.trim();
        if (!scenarioName) {
            alert('Введите название сценария');
            return;
        }
        
        const groupSelect = document.getElementById('groupSelect');
        if (!groupSelect || !groupSelect.value) {
            alert('Группа обязательна');
            return;
        }
        
        // Собираем временные точки
        const timePoints = [];
        const timePointElements = document.querySelectorAll('.time-point');
        
        if (timePointElements.length === 0) {
            alert('Добавьте хотя бы одну временную точку');
            return;
        }
        
        let hasErrors = false;
        timePointElements.forEach((timePoint, index) => {
            const dayInput = timePoint.querySelector('input[type="number"]');
            const timeInput = timePoint.querySelector('input[type="text"]');
            const dayValue = parseInt(dayInput.value, 10) || 0;
            const timeValue = timeInput.value.trim();
            
            if (isNaN(dayValue) || dayValue < 0) {
                alert(`Некорректный день для временной точки ${index + 1}. День должен быть >= 0`);
                hasErrors = true;
                return;
            }
            
            if (!timeValue) {
                alert(`Введите время для временной точки ${index + 1}`);
                hasErrors = true;
                return;
            }
            
            // Парсим время HH:mm
            const timeParts = timeValue.split(':');
            if (timeParts.length !== 2) {
                alert(`Некорректное время для временной точки ${index + 1}. Используйте формат HH:mm (00:00 - 23:59)`);
                hasErrors = true;
                return;
            }
            
            const hours = parseInt(timeParts[0], 10);
            const minutes = parseInt(timeParts[1], 10);
            
            if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                alert(`Некорректное время для временной точки ${index + 1}. Используйте формат HH:mm (00:00 - 23:59)`);
                hasErrors = true;
                return;
            }
            
            // Получаем выбранные шаблоны
            const templateCheckboxes = timePoint.querySelectorAll('input[type="checkbox"]:checked');
            if (templateCheckboxes.length === 0) {
                alert(`Выберите хотя бы один шаблон для временной точки ${index + 1}`);
                hasErrors = true;
                return;
            }
            
            templateCheckboxes.forEach(checkbox => {
                timePoints.push({
                    day: dayValue,
                    time: timeValue,
                    templateId: checkbox.value
                });
            });
        });
        
        if (hasErrors) {
            return;
        }
        
        if (timePoints.length === 0) {
            alert('Выберите хотя бы один шаблон для применения');
            return;
        }
        
        // Сортируем по дню и времени
        timePoints.sort((a, b) => {
            if (a.day !== b.day) return a.day - b.day;
            const [aHours, aMinutes] = a.time.split(':').map(Number);
            const [bHours, bMinutes] = b.time.split(':').map(Number);
            if (aHours !== bHours) return aHours - bHours;
            return aMinutes - bMinutes;
        });
        
        // Создаем запрос
        const today = new Date();
        const baseYear = today.getFullYear();
        const baseMonth = today.getMonth();
        const baseDay = today.getDate();
        
        const steps = timePoints.map((tp, index) => {
            const [hours, minutes] = tp.time.split(':').map(Number);
            const hoursStr = String(hours).padStart(2, '0');
            const minutesStr = String(minutes).padStart(2, '0');
            
            // Вычисляем дату с учетом дня
            const targetDate = new Date(baseYear, baseMonth, baseDay + tp.day);
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const day = String(targetDate.getDate()).padStart(2, '0');
            
            // Формат: HH:mm:ss dd-MM-yyyy
            const scheduledTime = `${hoursStr}:${minutesStr}:00 ${day}-${month}-${year}`;
            return {
                templateId: tp.templateId,
                delayMs: 0,
                scheduledTime: scheduledTime
            };
        });
        
        const requestBody = {
            name: scenarioName,
            description: document.getElementById('scenarioDescription').value.trim() || null,
            steps: steps
        };
        
        // Отправляем PUT запрос
        fetch('/api/scenarios/' + scenarioId, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.text().then(text => {
                    throw new Error(text || 'Ошибка при обновлении сценария');
                });
            }
        })
        .then(data => {
            window.location.href = '/scenarios/' + data.id + '?info=' + encodeURIComponent('Сценарий успешно обновлен');
        })
        .catch(error => {
            alert('Ошибка при обновлении сценария: ' + error.message);
        });
    });

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Отмечаем все используемые шаблоны в основной секции
        if (scenarioData && scenarioData.usedTemplateIds && scenarioData.usedTemplateIds.length > 0) {
            setTimeout(() => {
                scenarioData.usedTemplateIds.forEach(templateId => {
                    const checkbox = document.getElementById('template_' + templateId);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }, 50);
        }
        
        // Инициализируем временные точки с задержкой, чтобы секция шаблонов успела загрузиться
        setTimeout(() => {
            initializeTimePoints();
        }, 300);
        
        // Добавляем обработчики изменения чекбоксов в основной секции
        setTimeout(() => {
            const templatesSection = document.getElementById('templatesSection');
            if (templatesSection) {
                const checkboxes = templatesSection.querySelectorAll('.template-checkbox-input');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        // Обновляем все временные точки при изменении выбора
                        updateAllTimePoints();
                    });
                });
            }
        }, 400);
    });
</script>
<script th:src="@{/js/theme.js}"></script>
</body>
</html>

