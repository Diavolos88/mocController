<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–°–æ–∑–¥–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
    <link rel="stylesheet" th:href="@{/css/dark-theme.css}">
    <script th:src="@{/js/theme.js}"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            margin: 0;
            padding: 40px 20px;
            padding-top: 120px;
            background-color: #f5f5f5;
        }
        .fixed-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 16px 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .fixed-nav .nav-links {
            display: flex;
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .nav-links-main {
            display: flex;
            gap: 16px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }
        .nav-links-right {
            position: absolute;
            right: 0;
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: 32px;
        }
        .nav-link.secondary {
            padding: 6px 14px;
            font-size: 12px;
            min-width: auto;
        }
        .nav-link.faq {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(244, 67, 54, 0.2);
        }
        .nav-link.faq:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        .nav-link {
            padding: 14px 28px;
            text-decoration: none;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            /* –ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –µ—Å–ª–∏ –∫–ª–∞—Å—Å –Ω–µ —É–∫–∞–∑–∞–Ω */
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
        }
        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .nav-link.mocks {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(29, 114, 184, 0.2);
        }
        .nav-link.mocks:hover {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .nav-link.active {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .nav-link.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(29, 114, 184, 0.4);
        }
        /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–ª–∏ —Å–∏–Ω–∏–π —Ü–≤–µ—Ç */
        .nav-link.status.active {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%) !important;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4) !important;
        }
        .nav-link.groups.active {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%) !important;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4) !important;
        }
        .nav-link.faq.active {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%) !important;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4) !important;
        }
        .nav-link.mocks.active {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.4);
        }
        .nav-link.template {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(156, 39, 176, 0.2);
        }
        .nav-link.template:hover {
            background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }
        .nav-link.scenario {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.2);
        }
        .nav-link.scenario:hover {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }
        .nav-link.scenario.active {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }
        .nav-link.history {
            background: linear-gradient(135deg, #607d8b 0%, #455a64 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(96, 125, 139, 0.2);
        }
        .nav-link.history:hover {
            background: linear-gradient(135deg, #546e7a 0%, #37474f 100%);
            box-shadow: 0 4px 12px rgba(96, 125, 139, 0.3);
        }
        .nav-link.history.active {
            background: linear-gradient(135deg, #546e7a 0%, #37474f 100%);
            box-shadow: 0 4px 12px rgba(96, 125, 139, 0.4);
        }
        .nav-link.groups {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
        }
        .nav-link.groups:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        .nav-link.groups.active {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 32px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .back-link {
            display: inline-block;
            margin-bottom: 24px;
            text-decoration: none;
            color: #666;
            font-size: 14px;
            padding: 6px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .back-link:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }
        h1 { 
            margin: 0 0 8px 0; 
            font-size: 28px; 
            font-weight: 600;
            color: #333; 
        }
        .form-group {
            margin-bottom: 24px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .system-select {
            margin-bottom: 32px;
        }
        .templates-section {
            margin-bottom: 32px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        .templates-section h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
            color: #ff9800;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
        }
        .mock-group {
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
        }
        .mock-group h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .template-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fafafa;
            transition: all 0.2s;
        }
        .template-checkbox:hover {
            background: #f0f0f0;
            border-color: #ff9800;
        }
        .template-checkbox input[type="checkbox"] {
            width: auto;
            margin-right: 12px;
            cursor: pointer;
        }
        .template-checkbox label {
            flex: 1;
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }
        .template-info {
            font-size: 12px;
            color: #666;
            margin-left: 28px;
        }
        .time-points {
            margin-top: 32px;
        }
        .time-point {
            margin-bottom: 24px;
            padding: 20px;
            border: 2px solid #ff9800;
            border-radius: 6px;
            background: #fff8e1;
        }
        .time-point-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .time-point-title {
            font-size: 18px;
            font-weight: 600;
            color: #ff9800;
        }
        .time-input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }
        .time-input-group input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }
        .time-input-group input:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        .remove-time-btn {
            padding: 6px 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .remove-time-btn:hover {
            background: #d32f2f;
        }
        .add-time-btn {
            padding: 12px 24px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-top: 16px;
        }
        .add-time-btn:hover {
            background: #f57c00;
        }
        .actions {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-save {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(29, 114, 184, 0.2);
        }
        .btn-save:hover {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .btn-scenario {
            background: #ff9800;
            color: white;
        }
        .btn-scenario:hover {
            background: #f57c00;
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #ffcdd2;
        }
    </style>
</head>
<body>
<div class="fixed-nav">
    <div class="nav-links">
        <div class="nav-links-main">
            <a href="/" class="nav-link mocks">–ó–∞–≥–ª—É—à–∫–∏</a>
            <a href="/templates" class="nav-link template">–®–∞–±–ª–æ–Ω—ã</a>
            <a href="/scenarios" class="nav-link scenario active">–°—Ü–µ–Ω–∞—Ä–∏–∏</a>
        </div>
            <div class="nav-links-right">
                <a href="/history" class="nav-link history secondary">–ò—Å—Ç–æ—Ä–∏—è</a>
                <a href="/groups" class="nav-link groups secondary">–ì—Ä—É–ø–ø—ã</a>
            <a href="/status" class="nav-link status secondary">–°—Ç–∞—Ç—É—Å—ã</a>
            <a th:if="${faqUrl != null && !faqUrl.isEmpty()}" th:href="${faqUrl}" target="_blank" class="nav-link faq secondary">FAQ</a>
            <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
        </div>
    </div>
</div>

<div class="container">
    <a href="/scenarios" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</a>
    <h1>–°–æ–∑–¥–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</h1>

    <div th:if="${param.error}" class="error" th:text="${param.error[0]}"></div>

    <form id="scenarioForm" method="post" action="/scenarios/create">
        <div class="form-group">
            <label for="scenarioName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è *</label>
            <input type="text" id="scenarioName" name="name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–∫–∞–∑—ã –∑–∞–≥–ª—É—à–µ–∫" maxlength="255"/>
        </div>

        <div class="form-group system-select">
            <label for="groupSelect">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É *</label>
            <select id="groupSelect" name="group" required onchange="loadGroupTemplates(this.value)">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
                <option th:each="group : ${groups}" 
                        th:value="${group.id}" 
                        th:text="${group.name}">group</option>
            </select>
            <a href="/groups/new" target="_blank" style="margin-left: 12px; font-size: 14px; color: #1d72b8; text-decoration: none;">+ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</a>
        </div>

        <!-- –®–∞–±–ª–æ–Ω—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º -->
        <div id="templatesSection" class="templates-section" style="display: none;">
            <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã</h3>
            <div id="templatesContainer">
                <!-- –®–∞–±–ª–æ–Ω—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <div id="emptyState" class="empty-state">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã</p>
        </div>

        <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ -->
        <div class="time-points">
            <h2 style="margin-bottom: 16px; color: #ff9800;">–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏</h2>
            <div id="timePointsContainer">
                <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <button type="button" class="add-time-btn" onclick="addTimePoint()">+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è</button>
        </div>

        <div class="actions">
            <button type="submit" class="btn btn-save">–°–æ–∑–¥–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</button>
        </div>
    </form>
</div>

<script>
    let timePointCounter = 0;

    // –•—Ä–∞–Ω–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
    const allSelectedTemplates = new Map(); // templateId -> {id, name, mockName, system}
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤ –∏–∑ –≥—Ä—É–ø–ø—ã
    // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–∫–∞ —à–∞–±–ª–æ–Ω—É system-integration-mock
    function isValidTemplateName(systemName) {
        if (!systemName || systemName === '') {
            return false;
        }
        // –®–∞–±–ª–æ–Ω: –Ω–∞–∑–≤–∞–Ω–∏–µ_—Å–∏—Å—Ç–µ–º—ã-–Ω–∞–∑–≤–∞–Ω–∏–µ_—ç–º—É–ª—è—Ü–∏–∏-mock
        // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 —Ç–∏—Ä–µ –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ -mock
        let dashCount = 0;
        for (let i = 0; i < systemName.length; i++) {
            if (systemName[i] === '-') {
                dashCount++;
            }
        }
        return dashCount >= 2 && systemName.endsWith('-mock');
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏–∑ —à–∞–±–ª–æ–Ω–∞ system-integration-mock
    function extractSystemPrefix(systemName) {
        if (!systemName || systemName === '') {
            return systemName;
        }
        // –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –¥–æ –ø–µ—Ä–≤–æ–≥–æ —Ç–∏—Ä–µ
        const firstDashIndex = systemName.indexOf('-');
        if (firstDashIndex > 0) {
            return systemName.substring(0, firstDashIndex);
        }
        return systemName;
    }
    
    function loadGroupTemplates(groupId) {
        if (!groupId || groupId === '') {
            // –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, —Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —à–∞–±–ª–æ–Ω–æ–≤
            document.getElementById('templatesSection').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —à–∞–±–ª–æ–Ω–æ–≤
            document.getElementById('templatesContainer').innerHTML = '';
            allSelectedTemplates.clear();
            return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ
        fetch('/api/groups/' + encodeURIComponent(groupId))
            .then(response => response.json())
            .then(group => {
                if (!group || !group.systemNames || group.systemNames.length === 0) {
                    document.getElementById('templatesSection').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('emptyState').innerHTML = '<p>–í –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —Å–∏—Å—Ç–µ–º</p>';
                    return;
                }
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–±–ª–æ–Ω—ã
                document.getElementById('templatesContainer').innerHTML = '';
                allSelectedTemplates.clear();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.querySelector('.loading-text').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤...';
                    loadingOverlay.classList.add('active');
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º –∏–∑ –≥—Ä—É–ø–ø—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã —Å–∏—Å—Ç–µ–º (–¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤ system-integration-mock)
                const systemPrefixes = new Set();
                group.systemNames.forEach(system => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —à–∞–±–ª–æ–Ω—É system-integration-mock
                    if (isValidTemplateName(system)) {
                        const prefix = extractSystemPrefix(system);
                        systemPrefixes.add(prefix);
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —à–∞–±–ª–æ–Ω—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è
                        systemPrefixes.add(system);
                    }
                });
                
                const loadPromises = Array.from(systemPrefixes).map(systemPrefix => 
                    fetch('/api/templates/by-system/' + encodeURIComponent(systemPrefix))
                        .then(response => response.json())
                        .then(templates => ({ systemPrefix, templates }))
                        .catch(() => {
                            return { systemPrefix, templates: [] };
                        })
                );
                
                Promise.all(loadPromises)
                    .then(results => {
                        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å–µ —à–∞–±–ª–æ–Ω—ã –ø–æ mock
                        const mockGroups = {};
                        results.forEach(({ systemPrefix, templates }) => {
                            templates.forEach(template => {
                                const mockName = template.systemName || '–î—Ä—É–≥–∏–µ';
                                if (!mockGroups[mockName]) {
                                    mockGroups[mockName] = [];
                                }
                                mockGroups[mockName].push({ ...template, system: systemPrefix });
                            });
                        });
                        
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —à–∞–±–ª–æ–Ω—ã
                        const templatesContainer = document.getElementById('templatesContainer');
                        const templatesSection = document.getElementById('templatesSection');
                        const emptyState = document.getElementById('emptyState');
                        
                        if (Object.keys(mockGroups).length === 0) {
                            templatesSection.style.display = 'none';
                            emptyState.style.display = 'block';
                            emptyState.innerHTML = '<p>–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è —Å–∏—Å—Ç–µ–º –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ</p>';
                            return;
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —à–∞–±–ª–æ–Ω–æ–≤
                        templatesSection.style.display = 'block';
                        emptyState.style.display = 'none';
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        if (loadingOverlay) loadingOverlay.classList.remove('active');
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—ã mock
                        Object.entries(mockGroups).forEach(([mockName, templatesList]) => {
                            const mockGroupDiv = document.createElement('div');
                            mockGroupDiv.className = 'mock-group';
                            mockGroupDiv.setAttribute('data-mock-name', mockName);
                            
                            const h4 = document.createElement('h4');
                            h4.textContent = mockName;
                            mockGroupDiv.appendChild(h4);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º —à–∞–±–ª–æ–Ω—ã –≤ –≥—Ä—É–ø–ø—É
                            templatesList.forEach(template => {
                                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —à–∞–±–ª–æ–Ω–µ
                                allSelectedTemplates.set(template.id, {
                                    id: template.id,
                                    name: template.name,
                                    mockName: mockName,
                                    system: template.system
                                });
                                
                                // –°–æ–∑–¥–∞–µ–º —á–µ–∫–±–æ–∫—Å –¥–ª—è —à–∞–±–ª–æ–Ω–∞
                                const templateCheckbox = document.createElement('div');
                                templateCheckbox.className = 'template-checkbox';
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.id = 'template_' + template.id;
                                checkbox.value = template.id;
                                checkbox.className = 'template-checkbox-input';
                                checkbox.addEventListener('change', function() {
                                    updateAllTimePoints();
                                });
                                
                                const label = document.createElement('label');
                                label.htmlFor = 'template_' + template.id;
                                label.textContent = mockName + ' - ' + template.name;
                                
                                templateCheckbox.appendChild(checkbox);
                                templateCheckbox.appendChild(label);
                                
                                if (template.description) {
                                    const info = document.createElement('div');
                                    info.className = 'template-info';
                                    info.textContent = template.description;
                                    templateCheckbox.appendChild(info);
                                }
                                
                                mockGroupDiv.appendChild(templateCheckbox);
                            });
                            
                            templatesContainer.appendChild(mockGroupDiv);
                        });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
                        updateAllTimePoints();
                    })
                    .catch(() => {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –≥—Ä—É–ø–ø—ã');
                    });
            })
            .catch(() => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥—Ä—É–ø–ø—ã');
            });
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function addTimePoint() {
        timePointCounter++;
        const container = document.getElementById('timePointsContainer');
        const timePointDiv = document.createElement('div');
        timePointDiv.className = 'time-point';
        timePointDiv.id = 'timePoint_' + timePointCounter;
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã (—Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ–∫—Ü–∏–∏)
        const availableTemplates = getAvailableTemplates([]);
        
        timePointDiv.innerHTML = `
            <div class="time-point-header">
                <span class="time-point-title">–í—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ ${timePointCounter}</span>
                <button type="button" class="remove-time-btn" onclick="removeTimePoint(${timePointCounter})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div class="time-input-group">
                <label style="width: auto; margin: 0; font-weight: 500;">–î–µ–Ω—å:</label>
                <input type="number" 
                       name="timePoint_${timePointCounter}_day" 
                       id="timePoint_${timePointCounter}_day"
                       placeholder="0"
                       min="0"
                       value="0"
                       style="width: 80px;"
                       required/>
                <label style="width: auto; margin: 0; font-weight: 500; margin-left: 12px;">–í—Ä–µ–º—è (HH:mm):</label>
                <input type="text" 
                       name="timePoint_${timePointCounter}_time" 
                       id="timePoint_${timePointCounter}_time"
                       placeholder="00:00"
                       pattern="[0-9]{2}:[0-9]{2}"
                       maxlength="5"
                       required/>
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:</label>
                <div id="timePoint_${timePointCounter}_templates">
                    ${availableTemplates}
                </div>
            </div>
            <div style="margin-top: 12px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                <input type="text" 
                       name="timePoint_${timePointCounter}_comment" 
                       id="timePoint_${timePointCounter}_comment"
                       placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —ç—Ç–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏"
                       maxlength="500"
                       value=""
                       style="width: 100%; padding: 8px; border: 1px solid #d0d0d0; border-radius: 4px;"/>
            </div>
        `;
        
        container.appendChild(timePointDiv);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Å–∫—É –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏
        const timeInput = document.getElementById('timePoint_' + timePointCounter + '_time');
        timeInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) value = value.substring(0, 4);
            if (value.length >= 2) {
                value = value.substring(0, 2) + ':' + value.substring(2);
            }
            e.target.value = value;
        });
    }

    function removeTimePoint(id) {
        const timePoint = document.getElementById('timePoint_' + id);
        if (timePoint) {
            timePoint.remove();
        }
    }

    function getAvailableTemplates(selectedTemplateIds) {
        const templatesSection = document.getElementById('templatesSection');
        if (!templatesSection) return '<p style="color: #999; font-style: italic;">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</p>';
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
        const checkedCheckboxes = templatesSection.querySelectorAll('.template-checkbox-input:checked');
        
        if (checkedCheckboxes.length === 0) {
            return '<p style="color: #999; font-style: italic;">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω—ã –≤—ã—à–µ</p>';
        }
        
        let html = '';
        checkedCheckboxes.forEach(checkbox => {
            const label = checkbox.nextElementSibling;
            const templateId = checkbox.value;
            const fullLabelText = label.textContent.trim();
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ (mock) –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
            const mockGroup = checkbox.closest('.mock-group');
            const mockName = mockGroup ? (mockGroup.querySelector('h4') || mockGroup.querySelector('h3'))?.textContent.trim() : '';
            
            // –ï—Å–ª–∏ –≤ label —É–∂–µ –µ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç "mockName - templateName", –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            // –ò–Ω–∞—á–µ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏–∑ mockName –∏ templateName
            let displayText = fullLabelText;
            if (mockName && !fullLabelText.includes(' - ')) {
                displayText = `${mockName} - ${fullLabelText}`;
            }
            
            const isChecked = selectedTemplateIds && selectedTemplateIds.includes(templateId) ? 'checked' : '';
            html += `
                <div class="template-checkbox">
                    <input type="checkbox" 
                           name="timePoint_${timePointCounter}_templates" 
                           value="${templateId}"
                           id="timePoint_${timePointCounter}_template_${templateId}"
                           ${isChecked}/>
                    <label for="timePoint_${timePointCounter}_template_${templateId}" style="margin: 0;">${displayText}</label>
                </div>
            `;
        });
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ mock –≥—Ä—É–ø–ø–∞–º, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        const mockGroups = {};
        checkedCheckboxes.forEach(checkbox => {
            const mockGroup = checkbox.closest('.mock-group');
            if (mockGroup) {
                const mockName = (mockGroup.querySelector('h4') || mockGroup.querySelector('h3'))?.textContent.trim() || '–î—Ä—É–≥–∏–µ';
                if (!mockGroups[mockName]) {
                    mockGroups[mockName] = [];
                }
                const label = checkbox.nextElementSibling;
                const labelText = label.textContent.trim();
                // –ï—Å–ª–∏ –≤ label —É–∂–µ –µ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç "mockName - templateName", –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                // –ò–Ω–∞—á–µ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏–∑ mockName –∏ templateName
                let templateName = labelText;
                if (!labelText.includes(' - ')) {
                    templateName = `${mockName} - ${labelText}`;
                }
                mockGroups[mockName].push({
                    id: checkbox.value,
                    name: templateName
                });
            }
        });
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –≥—Ä—É–ø–ø—ã, —Ñ–æ—Ä–º–∏—Ä—É–µ–º HTML —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
        if (Object.keys(mockGroups).length > 0) {
            let groupedHtml = '';
            for (const [mockName, templates] of Object.entries(mockGroups)) {
                groupedHtml += `<div class="mock-group" style="margin-bottom: 12px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #1d72b8;">${mockName}</h3><div class="template-checkbox-group">`;
                templates.forEach(template => {
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ "mockName - templateName"
                    const displayText = template.name.includes(' - ') ? template.name : `${mockName} - ${template.name}`;
                    const isChecked = selectedTemplateIds && selectedTemplateIds.includes(template.id) ? 'checked' : '';
                    groupedHtml += `
                        <div class="template-checkbox">
                            <input type="checkbox" 
                                   name="timePoint_${timePointCounter}_templates" 
                                   value="${template.id}"
                                   id="timePoint_${timePointCounter}_template_${template.id}"
                                   ${isChecked}/>
                            <label for="timePoint_${timePointCounter}_template_${template.id}" style="margin: 0;">${displayText}</label>
                        </div>
                    `;
                });
                groupedHtml += '</div></div>';
            }
            return groupedHtml;
        }
        
        return html;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('scenarioForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const scenarioName = document.getElementById('scenarioName').value.trim();
        if (!scenarioName) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è');
            return;
        }
        
        const groupSelect = document.getElementById('groupSelect');
        if (!groupSelect || !groupSelect.value) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É');
            return;
        }
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
        const timePoints = [];
        const timePointElements = document.querySelectorAll('.time-point');
        
        if (timePointElements.length === 0) {
            alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–æ—á–∫—É');
            return;
        }
        
        let hasErrors = false;
        timePointElements.forEach((timePoint, index) => {
            const dayInput = timePoint.querySelector('input[type="number"]');
            const timeInput = timePoint.querySelector('input[type="text"]');
            const dayValue = parseInt(dayInput.value, 10) || 0;
            const timeValue = timeInput.value.trim();
            
            if (isNaN(dayValue) || dayValue < 0) {
                alert(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${index + 1}. –î–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >= 0`);
                hasErrors = true;
                return;
            }
            
            if (!timeValue) {
                alert(`–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${index + 1}`);
                hasErrors = true;
                return;
            }
            
            // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è HH:mm
            const timeParts = timeValue.split(':');
            if (timeParts.length !== 2) {
                alert(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${index + 1}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç HH:mm (00:00 - 23:59)`);
                hasErrors = true;
                return;
            }
            
            const hours = parseInt(timeParts[0], 10);
            const minutes = parseInt(timeParts[1], 10);
            
            if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                alert(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${index + 1}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç HH:mm (00:00 - 23:59)`);
                hasErrors = true;
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
            const templateCheckboxes = timePoint.querySelectorAll('input[type="checkbox"]:checked');
            if (templateCheckboxes.length === 0) {
                alert(`–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ ${index + 1}`);
                hasErrors = true;
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —ç—Ç–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏
            const commentInput = timePoint.querySelector('input[id$="_comment"]');
            const comment = commentInput ? commentInput.value.trim() : '';
            
            templateCheckboxes.forEach(checkbox => {
                timePoints.push({
                    day: dayValue,
                    time: timeValue,
                    templateId: checkbox.value,
                    comment: comment
                });
            });
        });
        
        if (hasErrors) {
            return;
        }
        
        if (timePoints.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è');
            return;
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–Ω—é –∏ –≤—Ä–µ–º–µ–Ω–∏
        timePoints.sort((a, b) => {
            if (a.day !== b.day) return a.day - b.day;
            const [aHours, aMinutes] = a.time.split(':').map(Number);
            const [bHours, bMinutes] = b.time.split(':').map(Number);
            if (aHours !== bHours) return aHours - bHours;
            return aMinutes - bMinutes;
        });
        
        // –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å
        // –î–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É + —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–µ–Ω—å
        const today = new Date();
        const baseYear = today.getFullYear();
        const baseMonth = today.getMonth();
        const baseDay = today.getDate();
        
        const steps = timePoints.map((tp, index) => {
            const [hours, minutes] = tp.time.split(':').map(Number);
            const hoursStr = String(hours).padStart(2, '0');
            const minutesStr = String(minutes).padStart(2, '0');
            
            // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É —Å —É—á–µ—Ç–æ–º –¥–Ω—è
            const targetDate = new Date(baseYear, baseMonth, baseDay + tp.day);
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const day = String(targetDate.getDate()).padStart(2, '0');
            
            // –§–æ—Ä–º–∞—Ç: HH:mm:ss dd-MM-yyyy
            const scheduledTime = `${hoursStr}:${minutesStr}:00 ${day}-${month}-${year}`;
            return {
                templateId: tp.templateId,
                delayMs: 0,
                scheduledTime: scheduledTime,
                comment: tp.comment || null
            };
        });
        
        const requestBody = {
            groupId: groupSelect.value,
            name: scenarioName,
            description: null,
            steps: steps
        };
        
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingOverlay = document.getElementById('loadingOverlay');
                const submitButton = scenarioForm.querySelector('button[type="submit"]');
                if (loadingOverlay) {
                    loadingOverlay.querySelector('.loading-text').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è...';
                    loadingOverlay.classList.add('active');
                }
                if (submitButton) {
                    submitButton.classList.add('button-loading');
                    submitButton.disabled = true;
                }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        fetch('/api/scenarios', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.text().then(text => {
                    throw new Error(text || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è');
                });
            }
        })
        .then(data => {
            window.location.href = '/scenarios/' + data.id + '?info=' + encodeURIComponent('–°—Ü–µ–Ω–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è: ' + error.message);
        })
        .finally(() => {
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            if (loadingOverlay) loadingOverlay.classList.remove('active');
            if (submitButton) {
                submitButton.classList.remove('button-loading');
                submitButton.disabled = false;
            }
        });
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤
    function updateAllTimePoints() {
        const timePointElements = document.querySelectorAll('.time-point');
        timePointElements.forEach(timePoint => {
            const templatesContainer = timePoint.querySelector('[id^="timePoint_"][id$="_templates"]');
            if (templatesContainer) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –≤ —ç—Ç–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–æ—á–∫–µ
                const selectedCheckboxes = templatesContainer.querySelectorAll('input[type="checkbox"]:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤
                templatesContainer.innerHTML = getAvailableTemplates(selectedIds);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
                selectedIds.forEach(templateId => {
                    const checkbox = templatesContainer.querySelector(`input[value="${templateId}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ—ë —à–∞–±–ª–æ–Ω—ã
        const groupSelect = document.getElementById('groupSelect');
        if (groupSelect && groupSelect.value) {
            loadGroupTemplates(groupSelect.value);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ–∫—Ü–∏–∏
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const templatesSection = document.getElementById('templatesSection');
        if (templatesSection) {
            templatesSection.addEventListener('change', function(e) {
                if (e.target.classList.contains('template-checkbox-input')) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞
                    updateAllTimePoints();
                }
            });
        }
    });
</script>
</body>
</html>

