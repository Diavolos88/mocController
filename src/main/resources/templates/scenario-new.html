<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Создать сценарий</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            margin: 0;
            padding: 40px 20px;
            padding-top: 120px;
            background-color: #f5f5f5;
        }
        .fixed-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 16px 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .fixed-nav .nav-links {
            display: flex;
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .nav-links-main {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .nav-links-right {
            position: absolute;
            right: 0;
        }
        .nav-link.faq {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
        }
        .nav-link.faq:hover {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        .nav-link {
            padding: 14px 28px;
            text-decoration: none;
            border: none;
            border-radius: 8px;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .nav-link.mocks {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(29, 114, 184, 0.2);
        }
        .nav-link.mocks:hover {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .nav-link.active {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .nav-link.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(29, 114, 184, 0.4);
        }
        .nav-link.mocks.active {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.4);
        }
        .nav-link.template {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(156, 39, 176, 0.2);
        }
        .nav-link.template:hover {
            background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }
        .nav-link.scenario {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.2);
        }
        .nav-link.scenario:hover {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }
        .nav-link.scenario.active {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 32px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .back-link {
            display: inline-block;
            margin-bottom: 24px;
            text-decoration: none;
            color: #666;
            font-size: 14px;
            padding: 6px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .back-link:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }
        h1 { 
            margin: 0 0 8px 0; 
            font-size: 28px; 
            font-weight: 600;
            color: #333; 
        }
        .form-group {
            margin-bottom: 24px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .system-select {
            margin-bottom: 32px;
        }
        .templates-section {
            margin-bottom: 32px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        .templates-section h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
            color: #ff9800;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
        }
        .mock-group {
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
        }
        .mock-group h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .template-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fafafa;
            transition: all 0.2s;
        }
        .template-checkbox:hover {
            background: #f0f0f0;
            border-color: #ff9800;
        }
        .template-checkbox input[type="checkbox"] {
            width: auto;
            margin-right: 12px;
            cursor: pointer;
        }
        .template-checkbox label {
            flex: 1;
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }
        .template-info {
            font-size: 12px;
            color: #666;
            margin-left: 28px;
        }
        .time-points {
            margin-top: 32px;
        }
        .time-point {
            margin-bottom: 24px;
            padding: 20px;
            border: 2px solid #ff9800;
            border-radius: 6px;
            background: #fff8e1;
        }
        .time-point-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .time-point-title {
            font-size: 18px;
            font-weight: 600;
            color: #ff9800;
        }
        .time-input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }
        .time-input-group input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }
        .time-input-group input:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        .remove-time-btn {
            padding: 6px 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .remove-time-btn:hover {
            background: #d32f2f;
        }
        .add-time-btn {
            padding: 12px 24px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-top: 16px;
        }
        .add-time-btn:hover {
            background: #f57c00;
        }
        .actions {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-save {
            background: linear-gradient(135deg, #1d72b8 0%, #155a94 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(29, 114, 184, 0.2);
        }
        .btn-save:hover {
            background: linear-gradient(135deg, #155a94 0%, #0f4a7a 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 184, 0.3);
        }
        .btn-scenario {
            background: #ff9800;
            color: white;
        }
        .btn-scenario:hover {
            background: #f57c00;
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #ffcdd2;
        }
    </style>
</head>
<body>
<div class="fixed-nav">
    <div class="nav-links">
        <div class="nav-links-main">
            <a href="/" class="nav-link">Заглушки</a>
            <a href="/templates" class="nav-link template">Шаблоны</a>
            <a href="/scenarios" class="nav-link scenario active">Сценарии</a>
        </div>
        <div class="nav-links-right" th:if="${faqUrl != null && !faqUrl.isEmpty()}">
            <a th:href="${faqUrl}" target="_blank" class="nav-link faq">FAQ</a>
        </div>
    </div>
</div>

<div class="container">
    <a href="/scenarios" class="back-link">← Назад к списку сценариев</a>
    <h1>Создать сценарий</h1>

    <div th:if="${param.error}" class="error" th:text="${param.error[0]}"></div>

    <form id="scenarioForm" method="post" action="/scenarios/create">
        <div class="form-group">
            <label for="scenarioName">Название сценария *</label>
            <input type="text" id="scenarioName" name="name" required placeholder="Например: Отказы заглушек" maxlength="255"/>
        </div>

        <div class="form-group">
            <label for="scenarioDescription">Описание (необязательно)</label>
            <textarea id="scenarioDescription" name="description" placeholder="Описание сценария..."></textarea>
        </div>

        <div class="form-group system-select">
            <label for="groupSelect">Выберите группу *</label>
            <select id="groupSelect" name="group" required onchange="loadGroupTemplates(this.value)">
                <option value="">-- Выберите группу --</option>
                <option th:each="group : ${groups}" 
                        th:value="${group.id}" 
                        th:text="${group.name}">group</option>
            </select>
            <a href="/groups/new" target="_blank" style="margin-left: 12px; font-size: 14px; color: #1d72b8; text-decoration: none;">+ Создать группу</a>
        </div>

        <!-- Шаблоны для выбранных систем -->
        <div id="templatesSection" class="templates-section" style="display: none;">
            <h3>Выбранные шаблоны</h3>
            <div id="templatesContainer">
                <!-- Шаблоны будут добавляться динамически -->
            </div>
        </div>

        <div id="emptyState" class="empty-state">
            <p>Выберите систему, чтобы увидеть доступные шаблоны</p>
        </div>

        <!-- Временные точки -->
        <div class="time-points">
            <h2 style="margin-bottom: 16px; color: #ff9800;">Временные точки</h2>
            <div id="timePointsContainer">
                <!-- Временные точки будут добавляться динамически -->
            </div>
            <button type="button" class="add-time-btn" onclick="addTimePoint()">+ Добавить время</button>
        </div>

        <div class="actions">
            <button type="submit" class="btn btn-save">Создать сценарий</button>
        </div>
    </form>
</div>

<script>
    let timePointCounter = 0;

    // Храним выбранные шаблоны
    const allSelectedTemplates = new Map(); // templateId -> {id, name, mockName, system}
    
    // Функция для загрузки шаблонов из группы
    function loadGroupTemplates(groupId) {
        if (!groupId || groupId === '') {
            // Если группа не выбрана, скрываем секцию шаблонов
            document.getElementById('templatesSection').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            // Очищаем контейнер шаблонов
            document.getElementById('templatesContainer').innerHTML = '';
            allSelectedTemplates.clear();
            return;
        }
        
        // Загружаем информацию о группе
        fetch('/api/groups/' + encodeURIComponent(groupId))
            .then(response => response.json())
            .then(group => {
                if (!group || !group.systemNames || group.systemNames.length === 0) {
                    document.getElementById('templatesSection').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('emptyState').innerHTML = '<p>В выбранной группе нет систем</p>';
                    return;
                }
                
                // Очищаем предыдущие шаблоны
                document.getElementById('templatesContainer').innerHTML = '';
                allSelectedTemplates.clear();
                
                // Показываем индикатор загрузки
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.querySelector('.loading-text').textContent = 'Загрузка шаблонов...';
                    loadingOverlay.classList.add('active');
                }
                
                // Загружаем шаблоны для всех систем из группы параллельно
                const loadPromises = group.systemNames.map(system => 
                    fetch('/api/templates/by-system/' + encodeURIComponent(system))
                        .then(response => response.json())
                        .then(templates => ({ system, templates }))
                        .catch(error => {
                            console.error('Ошибка при загрузке шаблонов для системы:', system, error);
                            return { system, templates: [] };
                        })
                );
                
                Promise.all(loadPromises)
                    .then(results => {
                        // Группируем все шаблоны по mock
                        const mockGroups = {};
                        results.forEach(({ system, templates }) => {
                            templates.forEach(template => {
                                const mockName = template.systemName || 'Другие';
                                if (!mockGroups[mockName]) {
                                    mockGroups[mockName] = [];
                                }
                                mockGroups[mockName].push({ ...template, system });
                            });
                        });
                        
                        // Отображаем шаблоны
                        const templatesContainer = document.getElementById('templatesContainer');
                        const templatesSection = document.getElementById('templatesSection');
                        const emptyState = document.getElementById('emptyState');
                        
                        if (Object.keys(mockGroups).length === 0) {
                            templatesSection.style.display = 'none';
                            emptyState.style.display = 'block';
                            emptyState.innerHTML = '<p>Нет шаблонов для систем в выбранной группе</p>';
                            return;
                        }
                        
                        // Показываем секцию шаблонов
                        templatesSection.style.display = 'block';
                        emptyState.style.display = 'none';
                        
                        // Скрываем индикатор загрузки
                        if (loadingOverlay) loadingOverlay.classList.remove('active');
                        
                        // Добавляем группы mock
                        Object.entries(mockGroups).forEach(([mockName, templatesList]) => {
                            const mockGroupDiv = document.createElement('div');
                            mockGroupDiv.className = 'mock-group';
                            mockGroupDiv.setAttribute('data-mock-name', mockName);
                            
                            const h4 = document.createElement('h4');
                            h4.textContent = mockName;
                            mockGroupDiv.appendChild(h4);
                            
                            // Добавляем шаблоны в группу
                            templatesList.forEach(template => {
                                // Сохраняем информацию о шаблоне
                                allSelectedTemplates.set(template.id, {
                                    id: template.id,
                                    name: template.name,
                                    mockName: mockName,
                                    system: template.system
                                });
                                
                                // Создаем чекбокс для шаблона
                                const templateCheckbox = document.createElement('div');
                                templateCheckbox.className = 'template-checkbox';
                                
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.id = 'template_' + template.id;
                                checkbox.value = template.id;
                                checkbox.className = 'template-checkbox-input';
                                checkbox.addEventListener('change', function() {
                                    updateAllTimePoints();
                                });
                                
                                const label = document.createElement('label');
                                label.htmlFor = 'template_' + template.id;
                                label.textContent = mockName + ' - ' + template.name;
                                
                                templateCheckbox.appendChild(checkbox);
                                templateCheckbox.appendChild(label);
                                
                                if (template.description) {
                                    const info = document.createElement('div');
                                    info.className = 'template-info';
                                    info.textContent = template.description;
                                    templateCheckbox.appendChild(info);
                                }
                                
                                mockGroupDiv.appendChild(templateCheckbox);
                            });
                            
                            templatesContainer.appendChild(mockGroupDiv);
                        });
                        
                        // Обновляем все временные точки
                        updateAllTimePoints();
                    })
                    .catch(error => {
                        console.error('Ошибка при загрузке шаблонов группы:', error);
                        alert('Ошибка при загрузке шаблонов для группы');
                    });
            })
            .catch(error => {
                console.error('Ошибка при загрузке группы:', error);
                alert('Ошибка при загрузке группы');
            });
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function addTimePoint() {
        timePointCounter++;
        const container = document.getElementById('timePointsContainer');
        const timePointDiv = document.createElement('div');
        timePointDiv.className = 'time-point';
        timePointDiv.id = 'timePoint_' + timePointCounter;
        
        // Получаем все доступные шаблоны (только выбранные в основной секции)
        const availableTemplates = getAvailableTemplates([]);
        
        timePointDiv.innerHTML = `
            <div class="time-point-header">
                <span class="time-point-title">Временная точка ${timePointCounter}</span>
                <button type="button" class="remove-time-btn" onclick="removeTimePoint(${timePointCounter})">Удалить</button>
            </div>
            <div class="time-input-group">
                <label style="width: auto; margin: 0; font-weight: 500;">День:</label>
                <input type="number" 
                       name="timePoint_${timePointCounter}_day" 
                       id="timePoint_${timePointCounter}_day"
                       placeholder="0"
                       min="0"
                       value="0"
                       style="width: 80px;"
                       required/>
                <label style="width: auto; margin: 0; font-weight: 500; margin-left: 12px;">Время (HH:mm):</label>
                <input type="text" 
                       name="timePoint_${timePointCounter}_time" 
                       id="timePoint_${timePointCounter}_time"
                       placeholder="00:00"
                       pattern="[0-9]{2}:[0-9]{2}"
                       maxlength="5"
                       required/>
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Выберите шаблоны для применения:</label>
                <div id="timePoint_${timePointCounter}_templates">
                    ${availableTemplates}
                </div>
            </div>
        `;
        
        container.appendChild(timePointDiv);
        
        // Добавляем маску для времени
        const timeInput = document.getElementById('timePoint_' + timePointCounter + '_time');
        timeInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) value = value.substring(0, 4);
            if (value.length >= 2) {
                value = value.substring(0, 2) + ':' + value.substring(2);
            }
            e.target.value = value;
        });
    }

    function removeTimePoint(id) {
        const timePoint = document.getElementById('timePoint_' + id);
        if (timePoint) {
            timePoint.remove();
        }
    }

    function getAvailableTemplates(selectedTemplateIds) {
        const templatesSection = document.getElementById('templatesSection');
        if (!templatesSection) return '<p style="color: #999; font-style: italic;">Сначала выберите группу</p>';
        
        // Получаем только выбранные шаблоны
        const checkedCheckboxes = templatesSection.querySelectorAll('.template-checkbox-input:checked');
        
        if (checkedCheckboxes.length === 0) {
            return '<p style="color: #999; font-style: italic;">Сначала выберите шаблоны выше</p>';
        }
        
        let html = '';
        checkedCheckboxes.forEach(checkbox => {
            const label = checkbox.nextElementSibling;
            const templateId = checkbox.value;
            const fullLabelText = label.textContent.trim();
            
            // Получаем информацию о группе (mock) для группировки
            const mockGroup = checkbox.closest('.mock-group');
            const mockName = mockGroup ? (mockGroup.querySelector('h4') || mockGroup.querySelector('h3'))?.textContent.trim() : '';
            
            // Если в label уже есть формат "mockName - templateName", используем его
            // Иначе формируем из mockName и templateName
            let displayText = fullLabelText;
            if (mockName && !fullLabelText.includes(' - ')) {
                displayText = `${mockName} - ${fullLabelText}`;
            }
            
            const isChecked = selectedTemplateIds && selectedTemplateIds.includes(templateId) ? 'checked' : '';
            html += `
                <div class="template-checkbox">
                    <input type="checkbox" 
                           name="timePoint_${timePointCounter}_templates" 
                           value="${templateId}"
                           id="timePoint_${timePointCounter}_template_${templateId}"
                           ${isChecked}/>
                    <label for="timePoint_${timePointCounter}_template_${templateId}" style="margin: 0;">${displayText}</label>
                </div>
            `;
        });
        
        // Группируем по mock группам, если они есть
        const mockGroups = {};
        checkedCheckboxes.forEach(checkbox => {
            const mockGroup = checkbox.closest('.mock-group');
            if (mockGroup) {
                const mockName = (mockGroup.querySelector('h4') || mockGroup.querySelector('h3'))?.textContent.trim() || 'Другие';
                if (!mockGroups[mockName]) {
                    mockGroups[mockName] = [];
                }
                const label = checkbox.nextElementSibling;
                const labelText = label.textContent.trim();
                // Если в label уже есть формат "mockName - templateName", используем его
                // Иначе формируем из mockName и templateName
                let templateName = labelText;
                if (!labelText.includes(' - ')) {
                    templateName = `${mockName} - ${labelText}`;
                }
                mockGroups[mockName].push({
                    id: checkbox.value,
                    name: templateName
                });
            }
        });
        
        // Если есть группы, формируем HTML с группировкой
        if (Object.keys(mockGroups).length > 0) {
            let groupedHtml = '';
            for (const [mockName, templates] of Object.entries(mockGroups)) {
                groupedHtml += `<div class="mock-group" style="margin-bottom: 12px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #1d72b8;">${mockName}</h3><div class="template-checkbox-group">`;
                templates.forEach(template => {
                    // Формируем текст в формате "mockName - templateName"
                    const displayText = template.name.includes(' - ') ? template.name : `${mockName} - ${template.name}`;
                    const isChecked = selectedTemplateIds && selectedTemplateIds.includes(template.id) ? 'checked' : '';
                    groupedHtml += `
                        <div class="template-checkbox">
                            <input type="checkbox" 
                                   name="timePoint_${timePointCounter}_templates" 
                                   value="${template.id}"
                                   id="timePoint_${timePointCounter}_template_${template.id}"
                                   ${isChecked}/>
                            <label for="timePoint_${timePointCounter}_template_${template.id}" style="margin: 0;">${displayText}</label>
                        </div>
                    `;
                });
                groupedHtml += '</div></div>';
            }
            return groupedHtml;
        }
        
        return html;
    }

    // Обработка отправки формы
    document.getElementById('scenarioForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const scenarioName = document.getElementById('scenarioName').value.trim();
        if (!scenarioName) {
            alert('Введите название сценария');
            return;
        }
        
        const groupSelect = document.getElementById('groupSelect');
        if (!groupSelect || !groupSelect.value) {
            alert('Выберите группу');
            return;
        }
        
        // Собираем временные точки
        const timePoints = [];
        const timePointElements = document.querySelectorAll('.time-point');
        
        if (timePointElements.length === 0) {
            alert('Добавьте хотя бы одну временную точку');
            return;
        }
        
        let hasErrors = false;
        timePointElements.forEach((timePoint, index) => {
            const dayInput = timePoint.querySelector('input[type="number"]');
            const timeInput = timePoint.querySelector('input[type="text"]');
            const dayValue = parseInt(dayInput.value, 10) || 0;
            const timeValue = timeInput.value.trim();
            
            if (isNaN(dayValue) || dayValue < 0) {
                alert(`Некорректный день для временной точки ${index + 1}. День должен быть >= 0`);
                hasErrors = true;
                return;
            }
            
            if (!timeValue) {
                alert(`Введите время для временной точки ${index + 1}`);
                hasErrors = true;
                return;
            }
            
            // Парсим время HH:mm
            const timeParts = timeValue.split(':');
            if (timeParts.length !== 2) {
                alert(`Некорректное время для временной точки ${index + 1}. Используйте формат HH:mm (00:00 - 23:59)`);
                hasErrors = true;
                return;
            }
            
            const hours = parseInt(timeParts[0], 10);
            const minutes = parseInt(timeParts[1], 10);
            
            if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                alert(`Некорректное время для временной точки ${index + 1}. Используйте формат HH:mm (00:00 - 23:59)`);
                hasErrors = true;
                return;
            }
            
            // Получаем выбранные шаблоны
            const templateCheckboxes = timePoint.querySelectorAll('input[type="checkbox"]:checked');
            if (templateCheckboxes.length === 0) {
                alert(`Выберите хотя бы один шаблон для временной точки ${index + 1}`);
                hasErrors = true;
                return;
            }
            
            templateCheckboxes.forEach(checkbox => {
                timePoints.push({
                    day: dayValue,
                    time: timeValue,
                    templateId: checkbox.value
                });
            });
        });
        
        if (hasErrors) {
            return;
        }
        
        if (timePoints.length === 0) {
            alert('Выберите хотя бы один шаблон для применения');
            return;
        }
        
        // Сортируем по дню и времени
        timePoints.sort((a, b) => {
            if (a.day !== b.day) return a.day - b.day;
            const [aHours, aMinutes] = a.time.split(':').map(Number);
            const [bHours, bMinutes] = b.time.split(':').map(Number);
            if (aHours !== bHours) return aHours - bHours;
            return aMinutes - bMinutes;
        });
        
        // Создаем запрос
        // Для временных точек используем сегодняшнюю дату + указанный день
        const today = new Date();
        const baseYear = today.getFullYear();
        const baseMonth = today.getMonth();
        const baseDay = today.getDate();
        
        const steps = timePoints.map((tp, index) => {
            const [hours, minutes] = tp.time.split(':').map(Number);
            const hoursStr = String(hours).padStart(2, '0');
            const minutesStr = String(minutes).padStart(2, '0');
            
            // Вычисляем дату с учетом дня
            const targetDate = new Date(baseYear, baseMonth, baseDay + tp.day);
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const day = String(targetDate.getDate()).padStart(2, '0');
            
            // Формат: HH:mm:ss dd-MM-yyyy
            const scheduledTime = `${hoursStr}:${minutesStr}:00 ${day}-${month}-${year}`;
            return {
                templateId: tp.templateId,
                delayMs: 0,
                scheduledTime: scheduledTime
            };
        });
        
        const requestBody = {
            groupId: groupSelect.value,
            name: scenarioName,
            description: document.getElementById('scenarioDescription').value.trim() || null,
            steps: steps
        };
        
                // Показываем индикатор загрузки
                const loadingOverlay = document.getElementById('loadingOverlay');
                const submitButton = scenarioForm.querySelector('button[type="submit"]');
                if (loadingOverlay) {
                    loadingOverlay.querySelector('.loading-text').textContent = 'Создание сценария...';
                    loadingOverlay.classList.add('active');
                }
                if (submitButton) {
                    submitButton.classList.add('button-loading');
                    submitButton.disabled = true;
                }
        
        // Отправляем запрос
        fetch('/api/scenarios', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.text().then(text => {
                    console.error('Ошибка сервера:', response.status, text);
                    throw new Error(text || 'Ошибка при создании сценария');
                });
            }
        })
        .then(data => {
            console.log('Сценарий успешно создан:', data);
            window.location.href = '/scenarios/' + data.id + '?info=' + encodeURIComponent('Сценарий успешно создан');
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка при создании сценария: ' + error.message);
        })
        .finally(() => {
            // Скрываем индикатор загрузки
            if (loadingOverlay) loadingOverlay.classList.remove('active');
            if (submitButton) {
                submitButton.classList.remove('button-loading');
                submitButton.disabled = false;
            }
        });
    });
    
    // Функция для обновления всех временных точек при изменении выбора шаблонов
    function updateAllTimePoints() {
        const timePointElements = document.querySelectorAll('.time-point');
        timePointElements.forEach(timePoint => {
            const templatesContainer = timePoint.querySelector('[id^="timePoint_"][id$="_templates"]');
            if (templatesContainer) {
                // Сохраняем выбранные шаблоны в этой временной точке
                const selectedCheckboxes = templatesContainer.querySelectorAll('input[type="checkbox"]:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                
                // Обновляем список шаблонов
                templatesContainer.innerHTML = getAvailableTemplates(selectedIds);
                
                // Восстанавливаем выбранные шаблоны
                selectedIds.forEach(templateId => {
                    const checkbox = templatesContainer.querySelector(`input[value="${templateId}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
        });
    }
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Если есть выбранная группа при загрузке страницы, загружаем её шаблоны
        const groupSelect = document.getElementById('groupSelect');
        if (groupSelect && groupSelect.value) {
            loadGroupTemplates(groupSelect.value);
        }
        
        // Добавляем обработчики изменения чекбоксов в основной секции
        // Используем делегирование событий для динамически добавляемых элементов
        const templatesSection = document.getElementById('templatesSection');
        if (templatesSection) {
            templatesSection.addEventListener('change', function(e) {
                if (e.target.classList.contains('template-checkbox-input')) {
                    // Обновляем все временные точки при изменении выбора
                    updateAllTimePoints();
                }
            });
        }
    });
</script>
</body>
</html>

